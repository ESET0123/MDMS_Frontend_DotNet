
<header class="top-header bg-dark py-3 shadow-sm">
    <div class="container-fluid">
        <div class="row align-items-center">
            <!-- Left: Logo -->
            <div class="col-md-4 d-flex align-items-center">
                <i class="bi bi-bullseye text-success fs-4"></i>
                <span class="ms-2 fw-bold text-success fs-5">MDMS - Admin Panel</span>
            </div>

            <div class="col-md-8 d-flex justify-content-end align-items-center">
                <!-- Profile Dropdown -->
                <div class="dropdown position-relative" id="profileDropdown">
                    <button id="profileBtn"
                            type="button"
                            class="btn btn-light btn-sm rounded-circle"
                            aria-haspopup="true"
                            aria-expanded="false"
                            aria-controls="profileMenu"
                            style="width:38px;height:38px;padding:0;display:flex;align-items:center;justify-content:center;">
                        <i class="bi bi-person-gear fs-5"></i>
                    </button>

                    <!-- Keep dropdown inside viewport -->
                    <ul id="profileMenu" class="dropdown-menu dropdown-menu-end shadow-sm position-absolute end-0 mt-2">
                        <li>
                            <a class="dropdown-item d-flex align-items-center" href="#" id="myProfileBtn">
                                <i class="bi bi-person-lines-fill me-2"></i>My Profile
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center text-danger" href="#" id="logoutBtn">
                                <i class="bi bi-box-arrow-right me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="profileModalLabel">
                    <i class="bi bi-person-lines-fill me-2"></i>Admin Profile
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="profileContent" class="row g-3 text-dark text-start">
                    <div class="text-center text-muted">Loading profile...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE_URL = '@Configuration["ApiBaseUrl"]';

    (function headerDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        const btn = document.getElementById('profileBtn');
        const menu = document.getElementById('profileMenu');

        // Ensure closed initially
        menu.classList.remove('show');
        btn.setAttribute('aria-expanded', 'false');

        // --- Dropdown Toggle ---
        function openMenu() {
            menu.classList.add('show');
            btn.setAttribute('aria-expanded', 'true');
            adjustPosition();
        }
        function closeMenu() {
            menu.classList.remove('show');
            btn.setAttribute('aria-expanded', 'false');
        }
        function toggleMenu(e) {
            e.preventDefault();
            e.stopPropagation();
            menu.classList.contains('show') ? closeMenu() : openMenu();
        }

        btn.addEventListener('click', toggleMenu);

        // Close when clicking outside, ESC, resize, or scroll
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) closeMenu();
        });
        document.addEventListener('keydown', (e) => e.key === 'Escape' && closeMenu());
        window.addEventListener('resize', closeMenu);
        window.addEventListener('scroll', closeMenu, true);

        // --- Adjust Position to Stay Within Viewport ---
        function adjustPosition() {
            const rect = menu.getBoundingClientRect();
            const vw = window.innerWidth;
            if (rect.right > vw - 4) {
                menu.style.left = 'auto';
                menu.style.right = '0'; // ensure it sticks to right edge
            } else {
                menu.style.left = '';
                menu.style.right = '';
            }
        }

        // --- Functional Buttons ---
        document.getElementById('logoutBtn').addEventListener('click', function (e) {
            e.preventDefault();
            closeMenu();
            localStorage.clear();
            window.location.href = '/Auth/Login';
        });

        document.getElementById('myProfileBtn').addEventListener('click', async function (e) {
            e.preventDefault();
            closeMenu();

            const token = localStorage.getItem('jwtToken');
            const userId = localStorage.getItem('userId');

            const modal = new bootstrap.Modal(document.getElementById('profileModal'));
            document.getElementById('profileContent').innerHTML =
                '<div class="text-center text-muted">Loading profile...</div>';
            modal.show();

            if (!userId || !token) {
                document.getElementById('profileContent').innerHTML =
                    '<div class="text-danger text-center">User ID or Token missing.</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/User/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch user details.');
                const data = await response.json();

                const html = `
                        <div class="col-md-6">
                            <div class="mb-3"><label class="form-label fw-semibold">User Number</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">${data.userNumber ?? '—'}</p></div>
                            <div class="mb-3"><label class="form-label fw-semibold">User ID</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">${data.userId ?? '—'}</p></div>
                            <div class="mb-3"><label class="form-label fw-semibold">Username</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">${data.username ?? '—'}</p></div>
                            <div class="mb-3"><label class="form-label fw-semibold">Email</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">${data.email ?? '—'}</p></div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3"><label class="form-label fw-semibold">Phone</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">${data.phone ?? '—'}</p></div>
                            <div class="mb-3"><label class="form-label fw-semibold">Role</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">${data.roleName ?? '—'}</p></div>
                            <div class="mb-3"><label class="form-label fw-semibold">Active Status</label>
                                <p class="form-control-plaintext">
                                    ${data.active
                        ? '<span class="badge bg-success">Active</span>'
                        : '<span class="badge bg-danger">Inactive</span>'}
                                </p></div>
                            <div class="mb-3"><label class="form-label fw-semibold">Last Login</label>
                                <p class="form-control-plaintext border rounded p-2 bg-light">
                                    ${data.lastLogin ? new Date(data.lastLogin).toLocaleString() : '—'}
                                </p></div>
                        </div>`;
                document.getElementById('profileContent').innerHTML = html;
            } catch (err) {
                document.getElementById('profileContent').innerHTML =
                    `<div class="text-danger text-center">Error loading profile: ${err.message}</div>`;
            }
        });
    })();
</script>

<style>
    .top-header {
        position: sticky;
        top: 0;
        z-index: 1020;
    }

    /* Keep menu inside view and style cleanly */
    .dropdown-menu {
        display: none;
        font-size: 0.9rem;
        border-radius: 10px;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        min-width: 180px;
        transform: translateY(5px);
        right: 0;
    }

        .dropdown-menu.show {
            display: block;
        }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: .5rem 1rem;
        transition: all .2s ease;
    }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #0d6efd;
        }

        .dropdown-item.text-danger:hover {
            background-color: #f8d7da;
            color: #dc3545;
        }

    /* Modal styling */
    .modal-content {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 1rem 3rem rgba(0,0,0,.175);
    }

    .modal-body p {
        background: #f8f9fa;
        padding: .5rem .75rem;
        border-radius: 6px;
    }

    .form-label {
        color: #0d6efd;
        font-size: .9rem;
        margin-bottom: .25rem;
    }
</style>
