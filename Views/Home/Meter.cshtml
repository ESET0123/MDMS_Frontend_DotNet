@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Meters Management";
    ViewData["ActivePage"] = "Meters";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Meters Management</h2>
            <p class="text-muted mb-0">Manage and monitor all electricity meters in your system</p>
        </div>
        <button class="btn btn-success px-4" id="addMeterBtn">
            <i class="bi bi-plus-circle me-2"></i> Add New Meter
        </button>
    </div>

    <!-- Filter Section -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light py-3">
            <h6 class="mb-0 fw-semibold"><i class="bi bi-funnel me-2"></i>Filter Meters</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-xl-2 col-md-4">
                    <label for="filterMeterId" class="form-label small fw-semibold text-muted">METER ID</label>
                    <input type="text" class="form-control" id="filterMeterId" placeholder="e.g., MTR0001">
                </div>
                <div class="col-xl-3 col-md-4">
                    <label for="filterConsumer" class="form-label small fw-semibold text-muted">CONSUMER NAME</label>
                    <input type="text" class="form-control" id="filterConsumer" placeholder="Search consumer...">
                </div>
                <div class="col-xl-2 col-md-4">
                    <label for="filterDtr" class="form-label small fw-semibold text-muted">DTR NAME</label>
                    <input type="text" class="form-control" id="filterDtr" placeholder="Search DTR...">
                </div>
                <div class="col-xl-2 col-md-4">
                    <label for="filterStatus" class="form-label small fw-semibold text-muted">STATUS</label>
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Decommissioned">Decommissioned</option>
                    </select>
                </div>
                <div class="col-xl-3 col-md-8 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Reset Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingSpinner" class="text-center py-5">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading meters data...</p>
    </div>

    <!-- Meters Table -->
    <div id="metersTableContainer" class="card border-0 shadow-sm" style="display: none;">
        <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold"><i class="bi bi-lightning-charge me-2"></i>Meters Overview</h6>
            <span class="badge bg-success bg-opacity-10 text-success" id="metersCount">0 meters</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="metersTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Meter Serial No.</th>
                            <th>Consumer Name</th>
                            <th>DTR Name</th>
                            <th>IP Address</th>
                            <th>ICCID</th>
                            <th>IMSI</th>
                            <th>Manufacturer</th>
                            <th>Firmware</th>
                            <th>Category</th>
                            <th>Install Date</th>
                            <th class="text-center pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="metersTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="card-footer bg-transparent border-0 py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0" id="pagination">
                </ul>
            </nav>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="alert alert-danger border-0 shadow-sm" role="alert" style="display: none;">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-5"></i>
            <div>
                <h6 class="alert-heading mb-1">Unable to Load Data</h6>
                <span id="errorText" class="small"></span>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Meter Modal -->
<div class="modal fade" id="addMeterModal" tabindex="-1" aria-labelledby="addMeterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addMeterModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Add New Meter
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="meterForm">
                    <input type="hidden" id="meterId" name="meterId">

                    <!-- Connection Details -->
                    <div class="mb-4">
                        <h6 class="fw-semibold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-link-45deg me-2"></i>Connection Details
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="consumerId" class="form-label fw-semibold">Consumer ID <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="consumerId" name="consumerId" required>
                                <div id="consumerValidation" class="mt-2"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dtrid" class="form-label fw-semibold">DTR ID <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="dtrid" name="dtrid" required>
                                <div id="dtrValidation" class="mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Network Details -->
                    <div class="mb-4">
                        <h6 class="fw-semibold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-wifi me-2"></i>Network Details
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ipaddress" class="form-label fw-semibold">IP Address <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="ipaddress" name="ipaddress" placeholder="192.168.1.1" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="iccid" class="form-label fw-semibold">ICCID</label>
                                <input type="text" class="form-control" id="iccid" name="iccid" placeholder="Enter ICCID">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="imsi" class="form-label fw-semibold">IMSI</label>
                                <input type="text" class="form-control" id="imsi" name="imsi" placeholder="Enter IMSI">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="firmware" class="form-label fw-semibold">Firmware Version</label>
                                <input type="text" class="form-control" id="firmware" name="firmware" placeholder="Enter firmware version">
                            </div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div class="mb-4">
                        <h6 class="fw-semibold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-gear me-2"></i>Configuration
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="manufacturerId" class="form-label fw-semibold">Manufacturer <span class="text-danger">*</span></label>
                                <select class="form-select" id="manufacturerId" name="manufacturerId" required>
                                    <option value="">Select Manufacturer</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tariffId" class="form-label fw-semibold">Tariff Plan <span class="text-danger">*</span></label>
                                <select class="form-select" id="tariffId" name="tariffId" required>
                                    <option value="">Select Tariff</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="installDate" class="form-label fw-semibold">Install Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="installDate" name="installDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="statusId" class="form-label fw-semibold">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="statusId" name="statusId" required>
                                    <option value="">Select Status</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Meter Reading -->
                    <div>
                        <h6 class="fw-semibold text-muted mb-3 border-bottom pb-2">
                            <i class="bi bi-speedometer2 me-2"></i>Current Reading
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="latestReading" class="form-label fw-semibold">Latest Reading (kWh) <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="latestReading" name="latestReading" value="0" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success px-4" onclick="saveMeter()">
                    <i class="bi bi-check-circle me-2"></i>Save Meter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Consumer Modal -->
<div class="modal fade" id="addConsumerModal" tabindex="-1" aria-labelledby="addConsumerModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addConsumerModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Add Consumer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="consumerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="consumerName" class="form-label fw-semibold">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="consumerName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="consumerEmail" class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="consumerEmail" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="consumerPhone" class="form-label fw-semibold">Phone</label>
                            <input type="tel" class="form-control" id="consumerPhone" placeholder="+1234567890">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="consumerAddress" class="form-label fw-semibold">Address <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="consumerAddress" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="consumerStatusId" class="form-label fw-semibold">Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="consumerStatusId" required>
                                <option value="">-- Select Status --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="consumerCreatedBy" class="form-label fw-semibold">Created By</label>
                            <input type="text" class="form-control" id="consumerCreatedBy" placeholder="Admin or Staff">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success px-4" onclick="saveNewConsumer()">
                    <i class="bi bi-save me-2"></i>Save Consumer
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@Configuration["ApiBaseUrl"]';
        let currentPage = 1;
        const itemsPerPage = 10;
        let allMeters = [];
        let filteredMeters = [];
        let allManufacturers = [];
        let allTariffs = [];
        let allStatuses = [];
        let meterModal = null;
        let consumerModal = null;
        let consumerCheckTimeout;

        // Wait for everything to be ready
        (function () {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMeterPage);
            } else {
                setTimeout(initMeterPage, 100);
            }
        })();

        function initMeterPage() {
            console.log('Initializing Meter Management Page...');

            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap not loaded, retrying...');
                setTimeout(initMeterPage, 100);
                return;
            }

            try {
                const meterModalEl = document.getElementById('addMeterModal');
                const consumerModalEl = document.getElementById('addConsumerModal');

                if (meterModalEl) {
                    meterModal = new bootstrap.Modal(meterModalEl, {
                        backdrop: true,
                        keyboard: true
                    });
                }

                if (consumerModalEl) {
                    consumerModal = new bootstrap.Modal(consumerModalEl, {
                        backdrop: false,
                        keyboard: true
                    });
                }

                document.getElementById('addMeterBtn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    openAddMeterModal();
                });

                // Add filter event listeners
                document.getElementById('filterMeterId')?.addEventListener('input', applyFilters);
                document.getElementById('filterConsumer')?.addEventListener('input', applyFilters);
                document.getElementById('filterDtr')?.addEventListener('input', applyFilters);
                document.getElementById('filterStatus')?.addEventListener('change', applyFilters);

                loadMeters();
                loadDropdowns();

                const consumerIdInput = document.getElementById('consumerId');
                if (consumerIdInput) {
                    consumerIdInput.addEventListener('input', function () {
                        clearTimeout(consumerCheckTimeout);
                        const consumerId = this.value.trim();
                        if (consumerId && consumerId > 0) {
                            consumerCheckTimeout = setTimeout(() => checkConsumerExists(consumerId), 500);
                        } else {
                            document.getElementById('consumerValidation').innerHTML = '';
                        }
                    });
                }

                const dtrIdInput = document.getElementById('dtrid');
                if (dtrIdInput) {
                    dtrIdInput.addEventListener('input', function () {
                        clearTimeout(consumerCheckTimeout);
                        const dtrId = this.value.trim();
                        if (dtrId && dtrId > 0) {
                            consumerCheckTimeout = setTimeout(() => checkDtrExists(dtrId), 500);
                        } else {
                            document.getElementById('dtrValidation').innerHTML = '';
                        }
                    });
                }

                console.log('✓ Meter management page initialized');
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize page: ' + error.message);
            }
        }

        function applyFilters() {
            const meterIdFilter = document.getElementById('filterMeterId').value.toLowerCase().trim();
            const consumerFilter = document.getElementById('filterConsumer').value.toLowerCase().trim();
            const dtrFilter = document.getElementById('filterDtr').value.toLowerCase().trim();
            const statusFilter = document.getElementById('filterStatus').value;

            filteredMeters = allMeters.filter(meter => {
                const meterSerial = `MTR${meter.meterId.toString().padStart(4, '0')}`.toLowerCase();
                const matchesMeterId = !meterIdFilter ||
                    meterSerial.includes(meterIdFilter) ||
                    meter.meterId.toString().includes(meterIdFilter);
                const matchesConsumer = !consumerFilter ||
                    meter.consumerName.toLowerCase().includes(consumerFilter);
                const matchesDtr = !dtrFilter ||
                    meter.dtrName.toLowerCase().includes(dtrFilter);
                const matchesStatus = !statusFilter ||
                    meter.statusName === statusFilter;

                return matchesMeterId && matchesConsumer && matchesDtr && matchesStatus;
            });

            currentPage = 1;
            displayMeters(currentPage);
            updateMetersCount();
        }

        function clearFilters() {
            document.getElementById('filterMeterId').value = '';
            document.getElementById('filterConsumer').value = '';
            document.getElementById('filterDtr').value = '';
            document.getElementById('filterStatus').value = '';
            filteredMeters = [...allMeters];
            currentPage = 1;
            displayMeters(currentPage);
            updateMetersCount();
        }

        function updateMetersCount() {
            const count = filteredMeters.length;
            const total = allMeters.length;
            const countElement = document.getElementById('metersCount');
            if (countElement) {
                countElement.textContent = `${count} meter${count !== 1 ? 's' : ''}${count !== total ? ` (filtered from ${total})` : ''}`;
            }
        }

        function openAddMeterModal() {
            console.log('Opening Add Meter Modal...');
            try {
                prepareAddMeter();

                if (meterModal) {
                    meterModal.show();
                    console.log('✓ Modal shown');
                } else {
                    console.error('✗ Modal instance not found, creating new one');
                    const modalEl = document.getElementById('addMeterModal');
                    if (modalEl) {
                        meterModal = new bootstrap.Modal(modalEl);
                        meterModal.show();
                    } else {
                        throw new Error('Modal element not found in DOM');
                    }
                }
            } catch (error) {
                console.error('✗ Error opening modal:', error);
                alert('Error opening meter form. Please refresh the page and try again.');
            }
        }

        function prepareAddMeter() {
            console.log('Preparing Add Meter form...');
            const form = document.getElementById('meterForm');
            if (form) {
                form.reset();
            }
            document.getElementById('meterId').value = '';
            document.getElementById('addMeterModalLabel').textContent = 'Add New Meter';
            document.getElementById('latestReading').value = '0';

            const validationDiv = document.getElementById('consumerValidation');
            if (validationDiv) {
                validationDiv.innerHTML = '';
            }

            const dtrValidationDiv = document.getElementById('dtrValidation');
            if (dtrValidationDiv) {
                dtrValidationDiv.innerHTML = '';
            }

            // Reset dropdowns
            document.getElementById('manufacturerId').value = '';
            document.getElementById('tariffId').value = '';
            document.getElementById('statusId').value = '';
        }

        async function checkConsumerExists(consumerId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Consumer/${consumerId}`);
                const validationDiv = document.getElementById('consumerValidation');

                if (response.ok) {
                    const consumer = await response.json();
                    validationDiv.innerHTML = `
                        <div class="alert alert-success py-2 mb-0 border-0">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Consumer Found:</strong> ${consumer.name}
                        </div>`;
                } else if (response.status === 404) {
                    validationDiv.innerHTML = `
                        <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="openCreateConsumerModal()">
                            <i class="bi bi-person-plus me-2"></i> Create New Consumer
                        </button>`;
                } else {
                    validationDiv.innerHTML = `
                        <div class="alert alert-warning py-2 mb-0 border-0">
                            <i class="bi bi-exclamation-triangle me-2"></i> Unable to verify consumer
                        </div>`;
                }
            } catch (error) {
                console.error('Error checking consumer:', error);
                document.getElementById('consumerValidation').innerHTML = `
                    <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="openCreateConsumerModal()">
                        <i class="bi bi-person-plus me-2"></i> Create New Consumer
                    </button>`;
            }
        }

        async function checkDtrExists(dtrId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Dtr/${dtrId}`);
                const validationDiv = document.getElementById('dtrValidation');

                if (response.ok) {
                    const dtr = await response.json();
                    validationDiv.innerHTML = `
                        <div class="alert alert-success py-2 mb-0 border-0">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>DTR Found:</strong> ${dtr.dtrname}
                        </div>`;
                }
                else if (response.status === 404) {
                    validationDiv.innerHTML = `
                        <button type="button" class="btn btn-outline-success btn-sm w-100"
                                onclick="redirectToAddDtr()">
                            <i class="bi bi-diagram-3 me-2"></i> Create New DTR
                        </button>`;
                }
                else {
                    validationDiv.innerHTML = `
                        <div class="alert alert-warning py-2 mb-0 border-0">
                            <i class="bi bi-exclamation-triangle me-2"></i> Unable to verify DTR
                        </div>`;
                }
            } catch (error) {
                console.error('Error checking DTR:', error);
                document.getElementById('dtrValidation').innerHTML = `
                    <button type="button" class="btn btn-outline-success btn-sm w-100"
                            onclick="redirectToAddDtr()">
                        <i class="bi bi-diagram-3 me-2"></i> Create New DTR
                    </button>`;
            }
        }

        function openCreateConsumerModal() {
            try {
                document.getElementById('consumerForm').reset();
                document.getElementById('consumerStatusId').innerHTML = '<option value="">-- Select Status --</option>';

                allStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.statusId;
                    option.textContent = status.name;
                    document.getElementById('consumerStatusId').appendChild(option);
                });

                document.body.classList.remove('modal-open');
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());

                setTimeout(() => {
                    consumerModal.show();
                }, 150);

                if (consumerModal) {
                    consumerModal.show();
                } else {
                    const modalEl = document.getElementById('addConsumerModal');
                    if (modalEl) {
                        consumerModal = new bootstrap.Modal(modalEl);
                        consumerModal.show();
                    }
                }
            } catch (error) {
                console.error('Error opening consumer modal:', error);
                alert('Error opening consumer form: ' + error.message);
            }
        }

        async function saveNewConsumer() {
            const form = document.getElementById('consumerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const consumerData = {
                name: document.getElementById('consumerName').value.trim(),
                email: document.getElementById('consumerEmail').value.trim(),
                phone: document.getElementById('consumerPhone').value.trim(),
                address: document.getElementById('consumerAddress').value.trim(),
                statusId: parseInt(document.getElementById('consumerStatusId').value),
                createdBy: document.getElementById('consumerCreatedBy').value.trim() || "System"
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/Consumer/Create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(consumerData)
                });

                if (!response.ok) throw new Error('Failed to create consumer');

                const locationHeader = response.headers.get('Location');
                let newConsumerId = null;

                if (locationHeader) {
                    const matches = locationHeader.match(/\/(\d+)$/);
                    if (matches) {
                        newConsumerId = matches[1];
                    }
                }

                consumerModal.hide();
                document.body.classList.remove('modal-open');
                document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());

                if (newConsumerId) {
                    document.getElementById('consumerId').value = newConsumerId;
                    checkConsumerExists(newConsumerId);
                }

                alert('Consumer created successfully!');
                form.reset();
            } catch (error) {
                alert('Error creating consumer: ' + error.message);
            }
        }

        async function loadMeters() {
            try {
                showLoading(true);
                const response = await fetch(`${API_BASE_URL}/api/Meter/AllMeters`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allMeters = await response.json();
                filteredMeters = [...allMeters];
                displayMeters(currentPage);
                updateMetersCount();
                showLoading(false);
            } catch (error) {
                console.error('Error loading meters:', error);
                showError('Failed to load meters data: ' + error.message);
                showLoading(false);
            }
        }

        function displayMeters(page) {
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const metersToDisplay = filteredMeters.slice(startIndex, endIndex);

            const tbody = document.getElementById('metersTableBody');
            tbody.innerHTML = '';

            if (metersToDisplay.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-search display-4"></i>
                                <p class="mt-3">No meters found matching your criteria</p>
                                <button class="btn btn-outline-success mt-2" onclick="clearFilters()">
                                    Clear Filters
                                </button>
                            </div>
                        </td>
                    </tr>`;
                return;
            }

            metersToDisplay.forEach(meter => {
                const row = document.createElement('tr');
                const rowClass = getStatusRowClass(meter.statusName);
                row.className = rowClass;

                row.innerHTML = `
                    <td class="ps-4 fw-semibold">MTR${meter.meterId.toString().padStart(4, '0')}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-light rounded-circle d-flex align-items-center justify-content-center me-3">
                                <i class="bi bi-person text-muted"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">${meter.consumerName}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${meter.dtrName}</span>
                    </td>
                    <td>
                        <code class="text-dark">${meter.ipaddress}</code>
                    </td>
                    <td>${meter.iccid || '<span class="text-muted">N/A</span>'}</td>
                    <td>${meter.imsi || '<span class="text-muted">N/A</span>'}</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">${meter.manufacturerName}</span>
                    </td>
                    <td>${meter.firmware || '<span class="text-muted">N/A</span>'}</td>
                    <td>
                        <span class="badge bg-info bg-opacity-10 text-info">${meter.tariffName}</span>
                    </td>
                    <td>
                        <small class="text-muted">${formatDate(meter.installDate)}</small>
                    </td>
                    <td class="text-center pe-4">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="editMeter(${meter.meterId})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            displayPagination();
        }

        function getStatusRowClass(status) {
            const statusClasses = {
                'Active': 'table-success',
                'Inactive': 'table-secondary',
                'Decommissioned': 'table-dark'
            };
            return statusClasses[status] || '';
        }

        function displayPagination() {
            const totalPages = Math.ceil(filteredMeters.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>`;
            pagination.appendChild(prevLi);

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                    pagination.appendChild(li);
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<a class="page-link" href="#">...</a>';
                    pagination.appendChild(li);
                }
            }

            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredMeters.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayMeters(currentPage);
            }
        }

        async function loadDropdowns() {
            try {
                await Promise.all([
                    loadManufacturers(),
                    loadTariffs(),
                    loadStatuses()
                ]);
            } catch (error) {
                console.error('Error loading dropdowns:', error);
            }
        }

        async function loadManufacturers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Manufacturer/AllManufacturers`);
                if (!response.ok) throw new Error('Failed to load manufacturers');

                allManufacturers = await response.json();
                const select = document.getElementById('manufacturerId');
                select.innerHTML = '<option value="">Select Manufacturer</option>';

                allManufacturers.forEach(manufacturer => {
                    const option = document.createElement('option');
                    option.value = manufacturer.manufacturerId;
                    option.textContent = manufacturer.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading manufacturers:', error);
            }
        }

        async function loadTariffs() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Tariff/AllTariffs`);
                if (!response.ok) throw new Error('Failed to load tariffs');

                allTariffs = await response.json();
                const select = document.getElementById('tariffId');
                select.innerHTML = '<option value="">Select Tariff</option>';

                allTariffs.forEach(tariff => {
                    const option = document.createElement('option');
                    option.value = tariff.tariffId;
                    option.textContent = tariff.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading tariffs:', error);
            }
        }

        async function loadStatuses() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Status/AllStatuses`);
                if (!response.ok) throw new Error('Failed to load statuses');

                allStatuses = await response.json();
                const select = document.getElementById('statusId');
                select.innerHTML = '<option value="">Select Status</option>';

                allStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.statusId;
                    option.textContent = status.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading statuses:', error);
            }
        }

        async function editMeter(meterId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/Meter/${meterId}`);
                if (!response.ok) throw new Error('Failed to fetch meter details');

                const meter = await response.json();

                document.getElementById('meterId').value = meter.meterId;
                document.getElementById('consumerId').value = meter.consumerId;
                document.getElementById('dtrid').value = meter.dtrid;
                document.getElementById('ipaddress').value = meter.ipaddress;
                document.getElementById('iccid').value = meter.iccid || '';
                document.getElementById('imsi').value = meter.imsi || '';
                document.getElementById('firmware').value = meter.firmware || '';
                document.getElementById('installDate').value = meter.installDate.split('T')[0];
                document.getElementById('latestReading').value = meter.latestReading;

                // Prepopulate dropdowns
                document.getElementById('manufacturerId').value = meter.manufacturerId;
                document.getElementById('tariffId').value = meter.tariffId;
                document.getElementById('statusId').value = meter.statusId;

                // Show validation for consumer and DTR
                checkConsumerExists(meter.consumerId);
                checkDtrExists(meter.dtrid);

                document.getElementById('addMeterModalLabel').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Meter';

                if (meterModal) {
                    meterModal.show();
                }
            } catch (error) {
                alert('Error loading meter: ' + error.message);
            }
        }

        async function saveMeter() {
            const form = document.getElementById('meterForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const meterId = document.getElementById('meterId').value;
            const meterData = {
                meterId: meterId ? parseInt(meterId) : null,
                consumerId: parseInt(document.getElementById('consumerId').value),
                dtrid: parseInt(document.getElementById('dtrid').value),
                ipaddress: document.getElementById('ipaddress').value,
                iccid: document.getElementById('iccid').value,
                imsi: document.getElementById('imsi').value,
                manufacturerId: parseInt(document.getElementById('manufacturerId').value),
                firmware: document.getElementById('firmware').value,
                tariffId: parseInt(document.getElementById('tariffId').value),
                installDate: document.getElementById('installDate').value,
                statusId: parseInt(document.getElementById('statusId').value),
                latestReading: parseFloat(document.getElementById('latestReading').value)
            };

            try {
                const url = meterId ? `${API_BASE_URL}/api/Meter/Update` : `${API_BASE_URL}/api/Meter/Create`;
                const method = meterId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(meterData)
                });

                if (!response.ok) throw new Error('Failed to save meter');

                if (meterModal) {
                    meterModal.hide();
                }
                form.reset();
                document.getElementById('consumerValidation').innerHTML = '';
                document.getElementById('dtrValidation').innerHTML = '';
                loadMeters();
                alert('Meter saved successfully!');
            } catch (error) {
                alert('Error saving meter: ' + error.message);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('metersTableContainer').style.display = show ? 'none' : 'block';
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('metersTableContainer').style.display = 'none';
        }

        function redirectToAddDtr() {
            window.location.href = '/Organization/OrgUnitHierarchy';
        }
    </script>
}

<style>
    :root {
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .card {
        border-radius: 12px;
        border: none;
    }

    .table th {
        font-weight: 600;
        white-space: nowrap;
        border-bottom: 2px solid #e9ecef;
        padding: 1rem;
    }

    .table td {
        padding: 1rem;
        vertical-align: middle;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .badge {
        font-size: 0.75em;
        padding: 0.35em 0.65em;
    }

    /* Row color coding based on status */
    .table-success {
        background-color: rgba(25, 135, 84, 0.05) !important;
        border-left: 4px solid #198754;
    }

    .table-secondary {
        background-color: rgba(108, 117, 125, 0.05) !important;
        border-left: 4px solid #6c757d;
    }

    .table-dark {
        background-color: rgba(33, 37, 41, 0.05) !important;
        border-left: 4px solid #212529;
    }

    /* Enhanced modal styling */
    .modal-header {
        border-radius: 12px 12px 0 0;
        padding: 1.5rem;
    }

    .modal-footer {
        border-radius: 0 0 12px 12px;
        padding: 1.5rem;
    }

    .form-label {
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    /* Avatar styling */
    .avatar-sm {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Pagination styling */
    .page-link {
        border: none;
        color: #6c757d;
        padding: 0.5rem 0.75rem;
    }

    .page-item.active .page-link {
        background-color: #198754;
        border-color: #198754;
    }

    .page-link:hover {
        background-color: #e9ecef;
        color: #198754;
    }

    /* Button hover effects */
    .btn {
        transition: all 0.2s ease;
    }

        .btn:hover {
            transform: translateY(-1px);
        }

    /* Table row hover effects */
    .table-hover tbody tr {
        transition: all 0.2s ease;
    }

        .table-hover tbody tr:hover {
            background-color: rgba(25, 135, 84, 0.08) !important;
            transform: translateX(2px);
        }

    /* Filter section improvements */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }

        .form-control:focus, .form-select:focus {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }

    

    /* Loading animation */
    .spinner-border {
        animation-duration: 0.75s;
    }

    /* Empty state styling */
    .bi-search.display-4 {
        font-size: 4rem;
        opacity: 0.5;
    }
</style>