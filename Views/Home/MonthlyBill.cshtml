@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Monthly Bills";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-file-invoice-dollar"></i> Monthly Bills Management</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#billModal" onclick="prepareAddBill()">
            <i class="bi bi-plus-circle"></i> Create New Bill
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Bills</h6>
                    <h3 id="totalBills">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted">Paid Bills</h6>
                    <h3 id="paidBills" class="text-success">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-danger border-4">
                <div class="card-body">
                    <h6 class="text-muted">Unpaid Bills</h6>
                    <h3 id="unpaidBills" class="text-danger">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted">Total Amount</h6>
                    <h3 id="totalAmount">₹0.00</h3>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingIndicator" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading bills...</p>
    </div>

    <div id="errorMessage" class="alert alert-danger alert-dismissible fade show" style="display: none;">
        <button type="button" class="btn-close" onclick="showError('')"></button>
        <span id="errorText"></span>
    </div>

    <div id="successMessage" class="alert alert-success alert-dismissible fade show" style="display: none;">
        <button type="button" class="btn-close" onclick="showSuccess('')"></button>
        <span id="successText"></span>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Bills</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="filterMeterId" class="form-label">Meter ID</label>
                    <input type="number" class="form-control" id="filterMeterId" placeholder="Enter Meter ID">
                </div>
                <div class="col-md-2">
                    <label for="filterConsumerId" class="form-label">Consumer ID</label>
                    <input type="number" class="form-control" id="filterConsumerId" placeholder="Enter Consumer ID">
                </div>
                <div class="col-md-2">
                    <label for="filterMonth" class="form-label">Month</label>
                    <select class="form-select" id="filterMonth">
                        <option value="">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filterYear" class="form-label">Year</label>
                    <input type="number" class="form-control" id="filterYear" placeholder="e.g., 2025">
                </div>
                <div class="col-md-2">
                    <label for="filterStatus" class="form-label">Status</label>
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="Paid">Paid</option>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Pending">Pending</option>
                        <option value="Overdue">Overdue</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="w-100">
                        <button type="button" class="btn btn-success w-100 mb-2" onclick="applyFilters()">
                            <i class="bi bi-search"></i> Apply
                        </button>
                        <button type="button" class="btn btn-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bills Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Bill ID</th>
                            <th>Meter ID</th>
                            <th>Consumer ID</th>
                            <th>Period</th>
                            <th>Consumption (kWh)</th>
                            <th>Total Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewBillModal" tabindex="-1" aria-labelledby="viewBillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewBillModalLabel">Bill Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Basic Information</h6>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Bill ID:</div>
                            <div class="col-7" id="viewBillId"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Meter ID:</div>
                            <div class="col-7" id="viewMeterId"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Consumer ID:</div>
                            <div class="col-7" id="viewConsumerId"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Billing Period:</div>
                            <div class="col-7" id="viewBillingPeriod"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Bill Duration:</div>
                            <div class="col-7" id="viewBillDuration"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Status:</div>
                            <div class="col-7" id="viewStatus"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2">Consumption & Generation</h6>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Consumption:</div>
                            <div class="col-7" id="viewConsumption"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Generated At:</div>
                            <div class="col-7" id="viewGeneratedAt"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Generated By:</div>
                            <div class="col-7" id="viewGeneratedBy"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 fw-bold">Paid Date:</div>
                            <div class="col-7" id="viewPaidDate"></div>
                        </div>
                    </div>
                </div>
                <hr>
                <h6 class="border-bottom pb-2">Billing Breakdown</h6>
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <td><strong>Base Amount</strong></td>
                            <td class="text-end" id="viewBaseAmount"></td>
                        </tr>
                        <tr>
                            <td><strong>Surge Charges</strong></td>
                            <td class="text-end text-danger" id="viewSurgeCharges"></td>
                        </tr>
                        <tr>
                            <td><strong>Discounts</strong></td>
                            <td class="text-end text-success" id="viewDiscounts"></td>
                        </tr>
                        <tr class="table-secondary">
                            <td><strong>Net Amount</strong></td>
                            <td class="text-end" id="viewNetAmount"></td>
                        </tr>
                        <tr>
                            <td><strong>Tax Amount</strong></td>
                            <td class="text-end" id="viewTaxAmount"></td>
                        </tr>
                        <tr class="table-primary">
                            <td><h5 class="mb-0">Total Amount</h5></td>
                            <td class="text-end"><h5 class="mb-0" id="viewTotalAmount"></h5></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Bill Modal -->
<div class="modal fade" id="billModal" tabindex="-1" aria-labelledby="billModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="billModalLabel">Create New Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="billForm">
                    <input type="hidden" id="isEdit" value="false" />
                    <input type="hidden" id="billId" value="0" />

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Basic Information</h6>
                            <div class="mb-3">
                                <label for="meterId" class="form-label">Meter ID <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="meterId" required>
                            </div>
                            <div class="mb-3">
                                <label for="consumerId" class="form-label">Consumer ID <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="consumerId" required>
                            </div>
                            <div class="mb-3">
                                <label for="billingMonth" class="form-label">Billing Month <span class="text-danger">*</span></label>
                                <select class="form-select" id="billingMonth" required>
                                    <option value="">Select Month</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="billingYear" class="form-label">Billing Year <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="billingYear" required>
                            </div>
                            <div class="mb-3">
                                <label for="billStartDate" class="form-label">Start Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="billStartDate" required>
                            </div>
                            <div class="mb-3">
                                <label for="billEndDate" class="form-label">End Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="billEndDate" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Charges & Amount</h6>
                            <div class="mb-3">
                                <label for="totalConsumptionKwh" class="form-label">Consumption (kWh) <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="totalConsumptionKwh" required>
                            </div>
                            <div class="mb-3">
                                <label for="baseAmount" class="form-label">Base Amount <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="baseAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="totalSurgeCharges" class="form-label">Surge Charges</label>
                                <input type="number" step="0.01" class="form-control" id="totalSurgeCharges" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="totalDiscounts" class="form-label">Discounts</label>
                                <input type="number" step="0.01" class="form-control" id="totalDiscounts" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="netAmount" class="form-label">Net Amount <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="netAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="taxAmount" class="form-label">Tax Amount <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="taxAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="totalAmount" class="form-label">Total Amount <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" class="form-control" id="totalAmount" required>
                            </div>
                            <div class="mb-3">
                                <label for="billStatus" class="form-label">Status <span class="text-danger">*</span></label>
                                <select class="form-select" id="billStatus" required>
                                    <option value="Unpaid">Unpaid</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="generatedBy" class="form-label">Generated By <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="generatedBy" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveBill()">
                    <i class="bi bi-save"></i> Save Bill
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@Configuration["ApiBaseUrl"]';
        const BILL_API_URL = `${API_BASE_URL}/api/MonthlyBill`;

        let allBills = [];
        let billModal;
        let viewBillModal;

        document.addEventListener('DOMContentLoaded', function() {
            billModal = new bootstrap.Modal(document.getElementById('billModal'));
            viewBillModal = new bootstrap.Modal(document.getElementById('viewBillModal'));
            fetchBills();
        });

        async function fetchBills() {
            try {
                showLoading(true);
                showError('');
                const response = await fetch(`${BILL_API_URL}/All`);

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                allBills = await response.json();
                renderBillsTable(allBills);
                updateStatistics(allBills);
                showLoading(false);
            } catch (error) {
                console.error('Error loading bills:', error);
                showError('Failed to load bills: ' + error.message);
                showLoading(false);
            }
        }

        function renderBillsTable(bills) {
            const tbody = document.getElementById('billsTableBody');
            tbody.innerHTML = '';

            if (bills && bills.length > 0) {
                bills.forEach(bill => {
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    const period = `${monthNames[bill.billingMonth - 1]} ${bill.billingYear}`;

                    let statusBadge = '';
                    switch(bill.billStatus) {
                        case 'Paid':
                            statusBadge = '<span class="badge bg-success">Paid</span>';
                            break;
                        case 'Unpaid':
                            statusBadge = '<span class="badge bg-danger">Unpaid</span>';
                            break;
                        case 'Pending':
                            statusBadge = '<span class="badge bg-warning">Pending</span>';
                            break;
                        case 'Overdue':
                            statusBadge = '<span class="badge bg-dark">Overdue</span>';
                            break;
                        default:
                            statusBadge = `<span class="badge bg-secondary">${bill.billStatus}</span>`;
                    }

                    const rowHtml = `
                        <tr data-meterid="${bill.meterId}"
                            data-consumerid="${bill.consumerId}"
                            data-month="${bill.billingMonth}"
                            data-year="${bill.billingYear}"
                            data-status="${bill.billStatus}">
                            <td><strong>${bill.billId}</strong></td>
                            <td><span class="badge bg-info">${bill.meterId}</span></td>
                            <td><span class="badge bg-secondary">${bill.consumerId}</span></td>
                            <td>${period}</td>
                            <td>${bill.totalConsumptionKwh.toFixed(2)}</td>
                            <td><strong>₹${bill.totalAmount.toFixed(2)}</strong></td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewBillDetails(${bill.billId})" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="editBill(${bill.billId})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteBill(${bill.billId})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', rowHtml);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No bills found. Click "Create New Bill" to add one.</td></tr>';
            }
        }

        function updateStatistics(bills) {
            const total = bills.length;
            const paid = bills.filter(b => b.billStatus === 'Paid').length;
            const unpaid = bills.filter(b => b.billStatus === 'Unpaid').length;
            const totalAmount = bills.reduce((sum, b) => sum + b.totalAmount, 0);

            document.getElementById('totalBills').textContent = total;
            document.getElementById('paidBills').textContent = paid;
            document.getElementById('unpaidBills').textContent = unpaid;
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;
        }

        function applyFilters() {
            const meterId = document.getElementById('filterMeterId').value;
            const consumerId = document.getElementById('filterConsumerId').value;
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            const status = document.getElementById('filterStatus').value;

            const rows = document.querySelectorAll('#billsTableBody tr');
            let filteredBills = [];

            rows.forEach(row => {
                let show = true;

                if (meterId && row.dataset.meterid !== meterId) show = false;
                if (consumerId && row.dataset.consumerid !== consumerId) show = false;
                if (month && row.dataset.month !== month) show = false;
                if (year && row.dataset.year !== year) show = false;
                if (status && row.dataset.status !== status) show = false;

                row.style.display = show ? '' : 'none';

                if (show) {
                    const billId = parseInt(row.querySelector('td:first-child strong').textContent);
                    const bill = allBills.find(b => b.billId === billId);
                    if (bill) filteredBills.push(bill);
                }
            });

            updateStatistics(filteredBills);
        }

        function clearFilters() {
            document.getElementById('filterMeterId').value = '';
            document.getElementById('filterConsumerId').value = '';
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterStatus').value = '';

            const rows = document.querySelectorAll('#billsTableBody tr');
            rows.forEach(row => row.style.display = '');

            updateStatistics(allBills);
        }

        function prepareAddBill() {
            document.getElementById('billModalLabel').textContent = 'Create New Bill';
            document.getElementById('billForm').reset();
            document.getElementById('isEdit').value = 'false';
            document.getElementById('billId').value = '0';
        }

        async function editBill(billId) {
            const bill = allBills.find(b => b.billId === billId);
            if (!bill) {
                showError('Bill not found');
                return;
            }

            document.getElementById('billModalLabel').textContent = 'Edit Bill';
            document.getElementById('isEdit').value = 'true';
            document.getElementById('billId').value = bill.billId;
            document.getElementById('meterId').value = bill.meterId;
            document.getElementById('consumerId').value = bill.consumerId;
            document.getElementById('billingMonth').value = bill.billingMonth;
            document.getElementById('billingYear').value = bill.billingYear;
            document.getElementById('billStartDate').value = bill.billStartDate;
            document.getElementById('billEndDate').value = bill.billEndDate;
            document.getElementById('totalConsumptionKwh').value = bill.totalConsumptionKwh;
            document.getElementById('baseAmount').value = bill.baseAmount;
            document.getElementById('totalSurgeCharges').value = bill.totalSurgeCharges;
            document.getElementById('totalDiscounts').value = bill.totalDiscounts;
            document.getElementById('netAmount').value = bill.netAmount;
            document.getElementById('taxAmount').value = bill.taxAmount;
            document.getElementById('totalAmount').value = bill.totalAmount;
            document.getElementById('billStatus').value = bill.billStatus;
            document.getElementById('generatedBy').value = bill.generatedBy;

            billModal.show();
        }

        async function saveBill() {
            const isEdit = document.getElementById('isEdit').value === 'true';

            const billData = {
                billId: isEdit ? parseInt(document.getElementById('billId').value) : null,
                meterId: parseInt(document.getElementById('meterId').value),
                consumerId: parseInt(document.getElementById('consumerId').value),
                billingMonth: parseInt(document.getElementById('billingMonth').value),
                billingYear: parseInt(document.getElementById('billingYear').value),
                billStartDate: document.getElementById('billStartDate').value,
                billEndDate: document.getElementById('billEndDate').value,
                totalConsumptionKwh: parseFloat(document.getElementById('totalConsumptionKwh').value),
                baseAmount: parseFloat(document.getElementById('baseAmount').value),
                totalSurgeCharges: parseFloat(document.getElementById('totalSurgeCharges').value),
                totalDiscounts: parseFloat(document.getElementById('totalDiscounts').value),
                netAmount: parseFloat(document.getElementById('netAmount').value),
                taxAmount: parseFloat(document.getElementById('taxAmount').value),
                totalAmount: parseFloat(document.getElementById('totalAmount').value),
                billStatus: document.getElementById('billStatus').value,
                generatedBy: document.getElementById('generatedBy').value,
                generatedAt: new Date().toISOString()
            };

            const endpoint = isEdit ? `${BILL_API_URL}/Update` : `${BILL_API_URL}/Create`;
            const method = isEdit ? 'PUT' : 'POST';

            try {
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(billData),
                });

                if (response.ok) {
                    billModal.hide();
                    showSuccess(isEdit ? 'Bill updated successfully!' : 'Bill created successfully!');
                    await fetchBills();
                } else {
                    const errorText = await response.text();
                    showError(`Failed to save bill: ${errorText}`);
                }
            } catch (error) {
                console.error('Error saving bill:', error);
                showError('An error occurred while saving the bill.');
            }
        }

        async function deleteBill(billId) {
            if (!confirm('Are you sure you want to delete this bill?')) {
                return;
            }

            try {
                const response = await fetch(`${BILL_API_URL}/${billId}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    showSuccess('Bill deleted successfully!');
                    await fetchBills();
                } else {
                    const errorText = await response.text();
                    showError(`Failed to delete bill: ${errorText}`);
                }
            } catch (error) {
                console.error('Error deleting bill:', error);
                showError('An error occurred while deleting the bill.');
            }
        }

        function viewBillDetails(billId) {
            const bill = allBills.find(b => b.billId === billId);
            if (!bill) {
                showError('Bill not found');
                return;
            }

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            document.getElementById('viewBillId').textContent = bill.billId;
            document.getElementById('viewMeterId').innerHTML = `<span class="badge bg-info">${bill.meterId}</span>`;
            document.getElementById('viewConsumerId').innerHTML = `<span class="badge bg-secondary">${bill.consumerId}</span>`;
            document.getElementById('viewBillingPeriod').textContent = `${monthNames[bill.billingMonth - 1]} ${bill.billingYear}`;
            document.getElementById('viewBillDuration').textContent = `${bill.billStartDate} to ${bill.billEndDate}`;

            let statusBadge = '';
            switch(bill.billStatus) {
                case 'Paid':
                    statusBadge = '<span class="badge bg-success">Paid</span>';
                    break;
                case 'Unpaid':
                    statusBadge = '<span class="badge bg-danger">Unpaid</span>';
                    break;
                case 'Pending':
                    statusBadge = '<span class="badge bg-warning">Pending</span>';
                    break;
                case 'Overdue':
                    statusBadge = '<span class="badge bg-dark">Overdue</span>';
                    break;
                default:
                    statusBadge = `<span class="badge bg-secondary">${bill.billStatus}</span>`;
            }
            document.getElementById('viewStatus').innerHTML = statusBadge;

            document.getElementById('viewConsumption').innerHTML = `<strong>${bill.totalConsumptionKwh.toFixed(2)} kWh</strong>`;
            document.getElementById('viewGeneratedAt').textContent = new Date(bill.generatedAt).toLocaleString();
            document.getElementById('viewGeneratedBy').textContent = bill.generatedBy;
            document.getElementById('viewPaidDate').textContent = bill.paidDate ? new Date(bill.paidDate).toLocaleString() : 'Not paid yet';

            document.getElementById('viewBaseAmount').textContent = `₹${bill.baseAmount.toFixed(2)}`;
            document.getElementById('viewSurgeCharges').textContent = `+ ₹${bill.totalSurgeCharges.toFixed(2)}`;
            document.getElementById('viewDiscounts').textContent = `- ₹${bill.totalDiscounts.toFixed(2)}`;
            document.getElementById('viewNetAmount').innerHTML = `<strong>₹${bill.netAmount.toFixed(2)}</strong>`;
            document.getElementById('viewTaxAmount').textContent = `+ ₹${bill.taxAmount.toFixed(2)}`;
            document.getElementById('viewTotalAmount').textContent = `₹${bill.totalAmount.toFixed(2)}`;

            viewBillModal.show();
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            if (message) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
            } else {
                errorDiv.style.display = 'none';
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            if (message) {
                successText.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
            } else {
                successDiv.style.display = 'none';
            }
        }
    </script>
}