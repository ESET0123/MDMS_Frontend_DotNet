@{
    Layout = "~/Views/Shared/_ConsumerLayout.cshtml";
    ViewData["Title"] = "Daily Meter Readings";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1"><i class="bi bi-calendar-day me-2 text-success"></i>Daily Meter Readings</h2>
            <p class="text-muted mb-0">View all your recorded meter readings, organized by date and meter.</p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-light py-3">
            <h6 class="mb-0 fw-semibold"><i class="bi bi-funnel me-2"></i>Filter Readings</h6>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="filterMeter" class="form-label small fw-semibold text-muted">METER</label>
                    <select id="filterMeter" class="form-select">
                        <option value="">Select Meter</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label small fw-semibold text-muted">START DATE</label>
                    <input type="date" id="startDate" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label small fw-semibold text-muted">END DATE</label>
                    <input type="date" id="endDate" class="form-control" />
                </div>
                <div class="col-md-2 d-flex gap-2">
                    <button class="btn btn-success w-100" id="filterBtn"><i class="bi bi-search me-1"></i>Apply</button>
                    <button class="btn btn-outline-secondary w-100" id="resetBtn"><i class="bi bi-arrow-clockwise me-1"></i>Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingSpinner" class="text-center my-5">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="mt-3 text-muted">Loading readings...</p>
    </div>

    <!-- Readings Table -->
    <div id="readingsContainer" class="card border-0 shadow-sm" style="display:none;">
        <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold"><i class="bi bi-list-ul me-2"></i>Readings Overview</h6>
            <span class="badge bg-success bg-opacity-10 text-success" id="readingCount">0 readings</span>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Meter ID</th>
                        <th>Total Consumption</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th class="text-center">View Details</th>
                    </tr>
                </thead>
                <tbody id="readingsTableBody">
                    <tr><td colspan="6" class="text-center text-muted py-5">No readings available.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal: Detailed Reading -->
<div class="modal fade" id="readingDetailModal" tabindex="-1" aria-labelledby="readingDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="readingDetailModalLabel"><i class="bi bi-clipboard-data me-2"></i>Reading Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div id="detailLoading" class="text-center py-4">
                    <div class="spinner-border text-success"></div>
                    <p class="text-muted mt-2">Loading details...</p>
                </div>
                <div id="detailContent" style="display:none;">
                    <h6 class="fw-bold mb-3 text-success">Date: <span id="detailDate"></span></h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>TOD Rule</th>
                                    <th>Time Slot</th>
                                    <th>Previous</th>
                                    <th>Current</th>
                                    <th>Consumption</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const API_BASE_URL = '@Configuration["ApiBaseUrl"]';
    const METER_API = `${API_BASE_URL}/api/Meter`;
    const DAILY_API = `${API_BASE_URL}/api/DailyMeterReading`;
    const token = localStorage.getItem('jwtToken');
    const consumerId = localStorage.getItem('consumerId');

    document.addEventListener('DOMContentLoaded', initConsumerReadings);

    async function initConsumerReadings() {
        try {
            await loadConsumerMeters();
            document.getElementById('filterBtn').addEventListener('click', loadReadings);
            document.getElementById('resetBtn').addEventListener('click', resetFilters);
            document.getElementById('loadingSpinner').style.display = 'block';
            await loadReadings();
        } catch (err) {
            console.error('Initialization failed:', err);
        }
    }

    async function loadConsumerMeters() {
        const res = await fetch(`${METER_API}/AllMeters`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const meters = await res.json();
        const consumerMeters = meters.filter(m => m.consumerId == consumerId);
        const select = document.getElementById('filterMeter');
        consumerMeters.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.meterId;
            opt.textContent = `Meter #${m.meterId} - ${m.consumerName}`;
            select.appendChild(opt);
        });
    }

    async function loadReadings() {
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('readingsContainer').style.display = 'none';
        const tbody = document.getElementById('readingsTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Loading...</td></tr>';

        const meterId = document.getElementById('filterMeter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        let readings = [];

        try {
            if (meterId && startDate && endDate) {
                const url = `${DAILY_API}/ByDateRange?meterId=${meterId}&startDate=${startDate}&endDate=${endDate}`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                readings = await res.json();
            } else if (meterId) {
                const url = `${DAILY_API}/ByMeter/${meterId}`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                readings = await res.json();
            }

            renderReadings(readings);
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error loading data.</td></tr>`;
            console.error('Error loading readings:', err);
        } finally {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    }

    function renderReadings(readings) {
        const tbody = document.getElementById('readingsTableBody');
        const countSpan = document.getElementById('readingCount');
        if (!readings || readings.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">No readings found for the selected criteria.</td></tr>`;
            countSpan.textContent = '0 readings';
            return;
        }

        // Group by date
        const grouped = {};
        readings.forEach(r => {
            const date = r.readingDate.split('T')[0];
            if (!grouped[date]) grouped[date] = [];
            grouped[date].push(r);
        });

        const dates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)); // Latest first
        tbody.innerHTML = '';

        dates.forEach(date => {
            const dayReadings = grouped[date];
            const totalConsumption = dayReadings.reduce((sum, r) => sum + (r.consumptionKwh || 0), 0);
            const totalAmount = dayReadings.reduce((sum, r) => sum + (r.amount || 0), 0);
            const meterId = dayReadings[0].meterId;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${date}</td>
                <td>MTR${meterId.toString().padStart(4, '0')}</td>
                <td>${totalConsumption.toFixed(2)} kWh</td>
                <td>₹${totalAmount.toFixed(2)}</td>
                <td><span class="badge bg-success bg-opacity-10 text-success">Recorded</span></td>
                <td class="text-center">
                    <button class="btn btn-outline-success btn-sm" onclick="showReadingDetails('${date}', ${meterId})">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>`;
            tbody.appendChild(tr);
        });

        document.getElementById('readingCount').textContent = `${dates.length} reading${dates.length > 1 ? 's' : ''}`;
        document.getElementById('readingsContainer').style.display = 'block';
    }

    async function showReadingDetails(date, meterId) {
        const modal = new bootstrap.Modal(document.getElementById('readingDetailModal'));
        document.getElementById('detailLoading').style.display = 'block';
        document.getElementById('detailContent').style.display = 'none';
        document.getElementById('detailTableBody').innerHTML = '';
        modal.show();

        try {
            const res = await fetch(`${DAILY_API}/ByDateRange?meterId=${meterId}&startDate=${date}&endDate=${date}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const readings = await res.json();
            renderDetailTable(readings, date);
        } catch (err) {
            document.getElementById('detailTableBody').innerHTML = `<tr><td colspan="6" class="text-center text-danger py-3">Failed to load details.</td></tr>`;
            console.error('Detail load error:', err);
        } finally {
            document.getElementById('detailLoading').style.display = 'none';
            document.getElementById('detailContent').style.display = 'block';
        }
    }

    function renderDetailTable(readings, date) {
        document.getElementById('detailDate').textContent = date;
        const tbody = document.getElementById('detailTableBody');
        tbody.innerHTML = readings.map(r => `
            <tr>
                <td>${r.todRuleName}</td>
                <td>${r.startTime} - ${r.endTime}</td>
                <td>${r.previousReading.toFixed(2)}</td>
                <td>${r.currentReading.toFixed(2)}</td>
                <td>${r.consumptionKwh.toFixed(2)} kWh</td>
                <td>₹${r.amount.toFixed(2)}</td>
            </tr>`).join('');
    }

    function resetFilters() {
        document.getElementById('filterMeter').value = '';
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        loadReadings();
    }
</script>

<style>
    .badge {
        font-size: 0.8rem;
        padding: 0.4em 0.65em;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(25, 135, 84, 0.08) !important;
        transition: all 0.2s ease;
    }
    .modal-content {
        border-radius: 12px;
    }
    .form-select, .form-control {
        border-radius: 8px;
    }
</style>
}