@{
    Layout = "~/Views/Shared/_ConsumerLayout.cshtml";
    ViewData["Title"] = "Consumer Dashboard";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold text-dark mb-1">Dashboard</h1>
                    <p class="text-muted">Welcome back! Here's your connected meters and recent energy usage.</p>
                </div>
                <div class="text-end">
                    <div class="text-muted small" id="currentDateTime"></div>
                    <button class="btn btn-sm btn-outline-secondary mt-1" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-5 py-5">
        <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading your dashboard...</p>
    </div>

    <!-- Statistics Cards -->
    <div id="statisticsCards" class="row g-4 mb-4" style="display: none;">
        <!-- Connected Meters -->
        <div class="col-xl-4 col-md-6">
            <a href="@Url.Action("MyMeters", "Consumer")" class="text-decoration-none">
                <div class="card stat-card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted small fw-semibold mb-2">CONNECTED METERS</h6>
                                <h2 class="fw-bold mb-0 text-dark" id="totalMeters">0</h2>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-success" id="meterProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="stat-icon text-success bg-success bg-opacity-10 p-3 rounded-circle">
                                <i class="bi bi-lightning-charge fs-3"></i>
                            </div>
                        </div>
                        <div class="border-top mt-3 pt-2">
                            <small class="text-muted"><i class="bi bi-arrow-right-circle me-1"></i> View all meters</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Active Meters -->
        <div class="col-xl-4 col-md-6">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted small fw-semibold mb-2">ACTIVE METERS</h6>
                            <h2 class="fw-bold mb-0 text-dark" id="activeMeters">0</h2>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-success" id="activeMeterProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="stat-icon text-success bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-check-circle fs-3"></i>
                        </div>
                    </div>
                    <div class="border-top mt-3 pt-2">
                        <small class="text-muted"><i class="bi bi-bar-chart me-1"></i> Meters transmitting data</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inactive Meters -->
        <div class="col-xl-4 col-md-6">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted small fw-semibold mb-2">INACTIVE METERS</h6>
                            <h2 class="fw-bold mb-0 text-dark" id="inactiveMeters">0</h2>
                            <div class="progress mt-2" style="height: 4px;">
                                <div class="progress-bar bg-danger" id="inactiveMeterProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="stat-icon text-danger bg-danger bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-slash-circle fs-3"></i>
                        </div>
                    </div>
                    <div class="border-top mt-3 pt-2">
                        <small class="text-muted"><i class="bi bi-exclamation-triangle me-1"></i> Meters not reporting data</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Consumption Graph -->
    <div id="consumptionGraphSection" class="row" style="display:none;">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pb-0 pt-4 px-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="fw-bold text-dark mb-0">
                                <i class="bi bi-graph-up-arrow text-success me-2"></i>Energy Consumption
                            </h5>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="badge bg-success bg-opacity-10 text-success">kWh</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Graph Controls -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="graphFilter" id="byDay" autocomplete="off" checked onchange="changeGraphType('day')">
                                    <label class="btn btn-outline-success" for="byDay">
                                        <i class="bi bi-calendar-day me-1"></i>By Day
                                    </label>

                                    <input type="radio" class="btn-check" name="graphFilter" id="byMonth" autocomplete="off" onchange="changeGraphType('month')">
                                    <label class="btn btn-outline-success" for="byMonth">
                                        <i class="bi bi-calendar-month me-1"></i>By Month
                                    </label>
                                </div>

                                <!-- Date Range Picker for Day View -->
                                <div id="dayRangePicker" class="d-flex gap-2 align-items-center">
                                    <input type="date" id="startDate" class="form-control form-control-sm" style="max-width: 140px;">
                                    <span class="text-muted">to</span>
                                    <input type="date" id="endDate" class="form-control form-control-sm" style="max-width: 140px;">
                                    <button class="btn btn-sm btn-success" onclick="applyDateFilter()">
                                        <i class="bi bi-filter"></i> Apply
                                    </button>
                                </div>

                                <!-- Month Picker for Month View -->
                                <div id="monthRangePicker" class="d-flex gap-2 align-items-center" style="display: none !important;">
                                    <input type="month" id="startMonth" class="form-control form-control-sm" style="max-width: 150px;">
                                    <span class="text-muted">to</span>
                                    <input type="month" id="endMonth" class="form-control form-control-sm" style="max-width: 150px;">
                                    <button class="btn btn-sm btn-success" onclick="applyMonthFilter()">
                                        <i class="bi bi-filter"></i> Apply
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Container -->
                    <canvas id="consumptionChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const token = localStorage.getItem('jwtToken');
    const consumerId = localStorage.getItem('consumerId');
    let currentGraphType = 'day';
    let currentMeterId = null;
    let consumptionChart = null;

    document.addEventListener('DOMContentLoaded', function () {
        updateDateTime();
        setInterval(updateDateTime, 60000);
        initializeDatePickers();
        fetchConsumerDashboard();
    });

    function updateDateTime() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
    }

    function initializeDatePickers() {
        const today = new Date();
        const weekAgo = new Date();
        weekAgo.setDate(today.getDate() - 6);

        // Set default date range (last 7 days)
        document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];

        // Set default month range (last 6 months)
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(today.getMonth() - 5);
        
        document.getElementById('startMonth').value = sixMonthsAgo.toISOString().substring(0, 7);
        document.getElementById('endMonth').value = today.toISOString().substring(0, 7);
    }

    function changeGraphType(type) {
        currentGraphType = type;
        
        if (type === 'day') {
            document.getElementById('dayRangePicker').style.display = 'flex';
            document.getElementById('monthRangePicker').style.display = 'none';
        } else {
            document.getElementById('dayRangePicker').style.display = 'none';
            document.getElementById('monthRangePicker').style.display = 'flex';
        }

        if (currentMeterId) {
            loadConsumptionData();
        }
    }

    async function fetchConsumerDashboard() {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('statisticsCards').style.display = 'none';
        document.getElementById('consumptionGraphSection').style.display = 'none';

        try {
            const meterRes = await fetch(`${API_BASE_URL}/api/Meter/AllMeters`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!meterRes.ok) throw new Error("Failed to load meter data");
            const meters = await meterRes.json();

            const consumerMeters = meters.filter(m => m.consumerId == consumerId);
            const totalMeters = consumerMeters.length;
            const activeMeters = consumerMeters.filter(m => m.statusName?.toLowerCase() === 'active').length;
            const inactiveMeters = totalMeters - activeMeters;

            // Animate values
            animateValue('totalMeters', 0, totalMeters, 800);
            animateValue('activeMeters', 0, activeMeters, 800);
            animateValue('inactiveMeters', 0, inactiveMeters, 800);

            // Set progress bars
            setProgress('meterProgress', totalMeters, totalMeters);
            setProgress('activeMeterProgress', activeMeters, totalMeters);
            setProgress('inactiveMeterProgress', inactiveMeters, totalMeters);

            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('statisticsCards').style.display = 'flex';

            if (consumerMeters.length > 0) {
                currentMeterId = consumerMeters[0].meterId;
                await loadConsumptionData();
            }
        } catch (error) {
            console.error('Dashboard load error:', error);
            document.getElementById('loadingIndicator').innerHTML =
                `<div class="alert alert-danger d-inline-block">
                    Failed to load dashboard data. 
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="fetchConsumerDashboard()">Retry</button>
                </div>`;
        }
    }

    async function loadConsumptionData() {
        if (!currentMeterId) return;

        try {
            if (currentGraphType === 'day') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const url = `${API_BASE_URL}/api/DailyMeterReading/ByDateRange?meterId=${currentMeterId}&startDate=${startDate}&endDate=${endDate}`;
                
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error("No daily consumption data found");
                const data = await res.json();
                renderDailyConsumptionChart(data);
                
            } else {
                // For monthly data, get all bills for the consumer
                const billsResponse = await fetch(`${API_BASE_URL}/api/MonthlyBill/ByConsumer/${consumerId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!billsResponse.ok) throw new Error("No monthly bill data found");
                const allBills = await billsResponse.json();

                // Filter bills for current meter and date range
                const startMonth = document.getElementById('startMonth').value;
                const endMonth = document.getElementById('endMonth').value;

                const filteredBills = allBills.filter(bill => {
                    const billMonthStr = `${bill.billingYear}-${String(bill.billingMonth).padStart(2, '0')}`;
                    return bill.meterId === currentMeterId && 
                           billMonthStr >= startMonth && 
                           billMonthStr <= endMonth;
                });

                // Sort by date
                filteredBills.sort((a, b) => {
                    if (a.billingYear !== b.billingYear) {
                        return a.billingYear - b.billingYear;
                    }
                    return a.billingMonth - b.billingMonth;
                });

                renderMonthlyConsumptionChart(filteredBills);
            }
            
            document.getElementById('consumptionGraphSection').style.display = 'block';
        } catch (err) {
            console.warn('Graph load failed:', err.message);
            showEmptyGraph();
            document.getElementById('consumptionGraphSection').style.display = 'block';
        }
    }

    function renderDailyConsumptionChart(readings) {
        if (!readings || readings.length === 0) {
            showEmptyGraph();
            return;
        }

        const labels = readings.map(r => {
            const date = new Date(r.readingDate);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const data = readings.map(r => r.consumptionKwh || 0);

        renderChart(labels, data, 'Daily Consumption (kWh)');
    }

    function renderMonthlyConsumptionChart(bills) {
        if (!bills || bills.length === 0) {
            showEmptyGraph();
            return;
        }

        const labels = bills.map(b => {
            return new Date(b.billingYear, b.billingMonth - 1).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        });
        const data = bills.map(b => b.totalConsumptionKwh || 0);

        renderChart(labels, data, 'Monthly Consumption (kWh)');
    }

    function renderChart(labels, data, label) {
        const ctx = document.getElementById('consumptionChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (consumptionChart) {
            consumptionChart.destroy();
        }

        consumptionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: label,
                    data,
                    fill: true,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.15)',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#198754',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                plugins: { 
                    legend: { 
                        display: true,
                        position: 'top',
                    } 
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { color: '#555' },
                        title: {
                            display: true,
                            text: 'Consumption (kWh)'
                        }
                    },
                    x: { 
                        ticks: { color: '#555' },
                        title: {
                            display: true,
                            text: currentGraphType === 'day' ? 'Date' : 'Month'
                        }
                    }
                }
            }
        });
    }

    function showEmptyGraph() {
        const ctx = document.getElementById('consumptionChart').getContext('2d');
        
        if (consumptionChart) {
            consumptionChart.destroy();
        }

        consumptionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['No Data Available'],
                datasets: [{
                    label: 'No consumption data available',
                    data: [0],
                    borderColor: '#6c757d',
                    backgroundColor: 'rgba(108, 117, 125, 0.1)',
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#555' } },
                    x: { ticks: { color: '#555' } }
                }
            }
        });
    }

    function applyDateFilter() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }

        if (new Date(startDate) > new Date(endDate)) {
            alert('Start date cannot be after end date');
            return;
        }

        loadConsumptionData();
    }

    function applyMonthFilter() {
        const startMonth = document.getElementById('startMonth').value;
        const endMonth = document.getElementById('endMonth').value;
        
        if (!startMonth || !endMonth) {
            alert('Please select both start and end months');
            return;
        }

        if (startMonth > endMonth) {
            alert('Start month cannot be after end month');
            return;
        }

        loadConsumptionData();
    }

    function animateValue(id, start, end, duration) {
        const el = document.getElementById(id);
        const range = end - start;
        const increment = range / (duration / 16);
        let current = start;
        const timer = setInterval(() => {
            current += increment;
            if ((increment > 0 && current >= end)) {
                current = end;
                clearInterval(timer);
            }
            el.textContent = Math.floor(current);
        }, 16);
    }

    function setProgress(id, value, total) {
        const percent = total === 0 ? 0 : (value / total) * 100;
        document.getElementById(id).style.width = percent + '%';
    }

    function refreshDashboard() {
        fetchConsumerDashboard();
    }
</script>

<style>
    :root {
        --primary-color: #198754;
        --primary-light: rgba(25, 135, 84, 0.1);
    }

    .stat-card {
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        transition: all 0.3s ease;
    }

    .stat-card:hover .stat-icon {
        transform: scale(1.1);
    }

    .btn-check:checked + .btn-outline-success {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }

    #dayRangePicker, #monthRangePicker {
        display: flex;
        align-items: center;
    }

    @@media (max-width: 768px) {
        .row.mb-4 .col-md-12 .d-flex {
            flex-direction: column;
            gap: 10px;
        }
        
        #dayRangePicker, #monthRangePicker {
            flex-direction: column;
            gap: 8px !important;
        }
        
        #dayRangePicker input, #monthRangePicker input {
            max-width: 100% !important;
        }
    }
</style>
}