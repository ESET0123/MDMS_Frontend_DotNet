@{
    Layout = "~/Views/Shared/_ConsumerLayout.cshtml";
    ViewData["Title"] = "My Monthly Bills";
}

<style>
    .bill-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: none;
        border-radius: 15px;
    }

        .bill-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }

    .status-badge {
        font-size: 0.75em;
        padding: 0.35em 0.65em;
    }

    .consumption-chart {
        height: 60px;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }

    .amount-display {
        font-size: 1.4em;
        font-weight: 700;
        color: #2c3e50;
    }

    .period-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
    }

    .action-btn {
        border-radius: 8px;
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
        transition: all 0.3s ease;
    }

    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        border: none;
    }

    .filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: none;
    }

    .table-hover tbody tr {
        transition: all 0.3s ease;
    }

        .table-hover tbody tr:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: scale(1.01);
        }

    .bill-summary {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .consumption-progress {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
        overflow: hidden;
    }

    .consumption-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .pay-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        color: white;
    }

        .pay-btn:hover {
            background: linear-gradient(135deg, #219e3e, #1ba87e);
            color: white;
            transform: translateY(-1px);
        }

        .pay-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

    .payment-processing {
        position: relative;
    }

    .payment-processing::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid #ffffff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .validation-alert {
        border-left: 4px solid #dc3545;
        background: #f8d7da;
    }

    .payment-success {
        border-left: 4px solid #28a745;
        background: #d4edda;
    }
</style>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-primary mb-1"><i class="bi bi-file-earmark-text me-2"></i>My Monthly Bills</h2>
                    <p class="text-muted mb-0">View and manage your electricity bills</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="fetchConsumerBills()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats" id="quickStats" style="display: none;">
        <div class="card stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-white-50 mb-1">Total Bills</h6>
                        <h3 class="mb-0 text-white" id="totalBillsCount">0</h3>
                    </div>
                    <div class="display-4 text-white-50">
                        <i class="bi bi-receipt"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="card stats-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-white-50 mb-1">Pending Amount</h6>
                        <h3 class="mb-0 text-white" id="pendingAmount">₹0</h3>
                    </div>
                    <div class="display-4 text-white-50">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="card stats-card" style="background: linear-gradient(135deg, #20c997 0%, #099268 100%);">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-white-50 mb-1">Avg. Consumption</h6>
                        <h3 class="mb-0 text-white" id="avgConsumption">0 kWh</h3>
                    </div>
                    <div class="display-4 text-white-50">
                        <i class="bi bi-lightning-charge"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm filter-section mb-4">
        <div class="card-header bg-transparent border-0 py-3">
            <h5 class="mb-0 text-dark"><i class="bi bi-funnel me-2"></i>Filter Bills</h5>
        </div>
        <div class="card-body pt-0">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label fw-semibold">Status</label>
                    <select class="form-select shadow-sm" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Paid">Paid</option>
                        <option value="Overdue">Overdue</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="monthFilter" class="form-label fw-semibold">Month</label>
                    <select class="form-select shadow-sm" id="monthFilter">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="yearFilter" class="form-label fw-semibold">Year</label>
                    <select class="form-select shadow-sm" id="yearFilter">
                        <option value="all">All Years</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary shadow-sm" onclick="clearFilters()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="text-center my-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading your bills...</p>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="alert alert-danger alert-dismissible fade show" style="display: none;">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span id="errorText"></span>
        </div>
        <button type="button" class="btn-close" onclick="showError('')"></button>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="alert alert-success alert-dismissible fade show" style="display: none;">
        <div class="d-flex align-items-center">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span id="successText"></span>
        </div>
        <button type="button" class="btn-close" onclick="showSuccess('')"></button>
    </div>

    <!-- Main Bills Table -->
    <div class="card shadow-sm bill-card" style="display: none;" id="billsTableCard">
        <div class="card-header bg-primary text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Bill History</h5>
                <span class="badge bg-light text-dark fs-6" id="billCount">0 bills</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="ps-4">Bill ID</th>
                            <th>Meter</th>
                            <th>Period</th>
                            <th>Billing Date</th>
                            <th>Consumption</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th class="text-center pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div class="text-center py-5" id="emptyState" style="display: none;">
        <div class="mb-4">
            <i class="bi bi-file-earmark-x text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-muted mb-3">No Bills Found</h4>
        <p class="text-muted mb-4">No bills match your current filter criteria.</p>
        <button class="btn btn-primary" onclick="clearFilters()">
            <i class="bi bi-arrow-clockwise me-1"></i>Clear Filters
        </button>
    </div>
</div>

<!-- Enhanced View Details Modal -->
<div class="modal fade" id="viewBillModal" tabindex="-1" aria-labelledby="viewBillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="viewBillModalLabel">
                    <i class="bi bi-receipt me-2"></i>Bill Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Bill Summary -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="bill-summary">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h4 class="mb-2">Bill #<span id="viewBillId"></span></h4>
                                    <p class="mb-0 text-black" id="viewBillingPeriod"></p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <h2 class="mb-0" id="viewTotalAmountModal"></h2>
                                    <span class="badge bg-white text-dark fs-6" id="viewStatusModal"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Left Column - Bill Information -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Bill Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label text-muted small mb-1">Bill ID</label>
                                        <p class="fw-bold mb-0" id="viewBillIdInfo"></p>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted small mb-1">Meter ID</label>
                                        <p class="fw-bold mb-0" id="viewMeterId"></p>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted small mb-1">Billing Period</label>
                                        <p class="fw-bold mb-0" id="viewBillingPeriodInfo"></p>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label text-muted small mb-1">Billing Date</label>
                                        <p class="fw-bold mb-0" id="viewBillingDate"></p>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-muted small mb-1">Status</label>
                                        <div id="viewStatus"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Consumption & Amount -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Consumption & Billing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-4">
                                        <div class="p-4 bg-light rounded-3">
                                            <i class="bi bi-lightning-charge-fill text-success display-6 mb-3"></i>
                                            <h6 class="text-muted mb-2">Total Consumption</h6>
                                            <h3 class="text-success mb-0" id="viewTotalConsumption"></h3>
                                            <small class="text-muted">kilowatt-hours</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-4">
                                        <div class="p-4 bg-warning bg-opacity-10 rounded-3">
                                            <i class="bi bi-currency-rupee text-warning display-6 mb-3"></i>
                                            <h6 class="text-muted mb-2">Total Amount</h6>
                                            <h3 class="text-warning mb-0" id="viewTotalAmount"></h3>
                                            <small class="text-muted">Indian Rupees</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Consumption Progress -->
                                <div class="mt-3">
                                    <label class="form-label text-muted small mb-2">Consumption Level</label>
                                    <div class="consumption-progress">
                                        <div class="consumption-progress-bar" id="consumptionProgress"></div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <small class="text-muted">Low</small>
                                        <small class="text-muted">High</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Close
                </button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentBillPDF()">
                    <i class="bi bi-file-pdf me-1"></i>Download PDF
                </button>
                <button type="button" class="btn pay-btn" id="payBillBtn" onclick="payCurrentBill()">
                    <i class="bi bi-credit-card me-1"></i>Pay Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Confirmation Modal -->
<div class="modal fade" id="paymentConfirmationModal" tabindex="-1" aria-labelledby="paymentConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="paymentConfirmationModalLabel">
                    <i class="bi bi-credit-card me-2"></i>Confirm Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-credit-card-2-front display-1 text-warning"></i>
                </div>
                <h5 class="text-center mb-3">Confirm Bill Payment</h5>

                <div class="alert alert-info mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>Bill ID:</strong>
                        <span id="confirmBillId"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <strong>Amount:</strong>
                        <span id="confirmBillAmount"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <strong>Period:</strong>
                        <span id="confirmBillPeriod"></span>
                    </div>
                </div>

                <!-- Payment Validation Result -->
                <div id="paymentValidationResult" style="display: none;">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Payment Method Selection -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Payment Method</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="credit" checked>
                        <label class="form-check-label" for="creditCard">
                            <i class="bi bi-credit-card me-1"></i>Credit/Debit Card
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="netBanking" value="netbanking">
                        <label class="form-check-label" for="netBanking">
                            <i class="bi bi-bank me-1"></i>Net Banking
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="upi" value="upi">
                        <label class="form-check-label" for="upi">
                            <i class="bi bi-phone me-1"></i>UPI Payment
                        </label>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <small>By proceeding, you agree to pay the bill amount. This action cannot be undone.</small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn pay-btn" id="confirmPaymentBtn" onclick="processPayment()">
                    <i class="bi bi-credit-card me-1"></i>Confirm Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Processing Modal -->
<div class="modal fade" id="paymentProcessingModal" tabindex="-1" aria-labelledby="paymentProcessingModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title" id="paymentProcessingModalLabel">
                    <i class="bi bi-arrow-repeat me-2"></i>Processing Payment
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <h5 class="text-primary mb-2">Processing Your Payment</h5>
                <p class="text-muted mb-0">Please wait while we process your payment. Do not close this window.</p>
            </div>
        </div>
    </div>
</div>

<!-- Payment Success Modal -->
<div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-labelledby="paymentSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white border-0">
                <h5 class="modal-title" id="paymentSuccessModalLabel">
                    <i class="bi bi-check-circle me-2"></i>Payment Successful
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-check-circle-fill display-1 text-success"></i>
                </div>
                <h4 class="text-success mb-3">Payment Completed Successfully!</h4>
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between">
                        <strong>Bill ID:</strong>
                        <span id="successBillId"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <strong>Amount Paid:</strong>
                        <span id="successBillAmount"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <strong>Transaction Date:</strong>
                        <span id="successTransactionDate"></span>
                    </div>
                </div>
                <p class="text-muted">Your bill has been marked as paid. A receipt has been generated for your records.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-success w-100" onclick="handlePaymentSuccess()">
                    <i class="bi bi-download me-1"></i>Download Receipt & Close
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const BILL_API_URL = `${API_BASE_URL}/api/MonthlyBill`;
        const CONSUMER_API_URL = `${API_BASE_URL}/api/Consumer`;

        let allBills = [];
        let filteredBills = [];
        let currentConsumerId = null;
        let currentConsumerData = null;
        let currentBillForDetails = null;
        let currentBillForPayment = null;

        let viewBillModal;
        let paymentConfirmationModal;
        let paymentProcessingModal;
        let paymentSuccessModal;

        document.addEventListener('DOMContentLoaded', function () {
            viewBillModal = new bootstrap.Modal(document.getElementById('viewBillModal'));
            paymentConfirmationModal = new bootstrap.Modal(document.getElementById('paymentConfirmationModal'));
            paymentProcessingModal = new bootstrap.Modal(document.getElementById('paymentProcessingModal'));
            paymentSuccessModal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'));

            // Setup filter event listeners
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('monthFilter').addEventListener('change', applyFilters);
            document.getElementById('yearFilter').addEventListener('change', applyFilters);

            // Get current consumer ID
            getCurrentConsumerId().then(consumerId => {
                if (consumerId) {
                    currentConsumerId = consumerId;
                    loadConsumerData().then(() => {
                        fetchConsumerBills();
                    });
                } else {
                    showError('Unable to load consumer information. Please log in again.');
                    showLoading(false);
                }
            });
        });

        // Function to get current consumer ID from localStorage
        async function getCurrentConsumerId() {
            try {
                const consumerId = localStorage.getItem('consumerId');
                if (!consumerId) {
                    console.error('No consumer ID found in localStorage');
                    return null;
                }
                return parseInt(consumerId);
            } catch (error) {
                console.error('Error getting consumer ID:', error);
                return null;
            }
        }

        // Load consumer data for PDF generation
        async function loadConsumerData() {
            try {
                const response = await fetch(`${CONSUMER_API_URL}/${currentConsumerId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    currentConsumerData = await response.json();
                }
            } catch (error) {
                console.error('Error loading consumer data:', error);
            }
        }

        async function fetchConsumerBills() {
            if (!currentConsumerId) {
                showError('Consumer information not available. Please log in again.');
                showLoading(false);
                return;
            }

            try {
                showLoading(true);
                showError('');

                const response = await fetch(`${BILL_API_URL}/ByConsumer/${currentConsumerId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allBills = await response.json();

                // Sort bills by billing year and month (latest first)
                allBills.sort((a, b) => {
                    if (a.billingYear !== b.billingYear) {
                        return b.billingYear - a.billingYear;
                    }
                    return b.billingMonth - a.billingMonth;
                });

                populateYearFilter();
                applyFilters();
                updateQuickStats();
                showLoading(false);

            } catch (error) {
                console.error('Error loading bills:', error);
                showError('Failed to load bills: ' + error.message);
                showLoading(false);

                // Ensure table is hidden on error
                document.getElementById('billsTableCard').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function populateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const years = [...new Set(allBills.map(bill => bill.billingYear))].sort((a, b) => b - a);

            yearFilter.innerHTML = '<option value="all">All Years</option>';

            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const selectedStatus = document.getElementById('statusFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;

            filteredBills = allBills.filter(bill => {
                const statusMatch = selectedStatus === 'all' || bill.billStatus === selectedStatus;
                const monthMatch = selectedMonth === 'all' || bill.billingMonth.toString() === selectedMonth;
                const yearMatch = selectedYear === 'all' || bill.billingYear.toString() === selectedYear;
                return statusMatch && monthMatch && yearMatch;
            });

            renderBillsTable(filteredBills);
            updateBillCount();
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('monthFilter').value = 'all';
            document.getElementById('yearFilter').value = 'all';
            applyFilters();
        }

        function updateQuickStats() {
            if (allBills.length === 0) return;

            const totalBills = allBills.length;
            const pendingAmount = allBills
                .filter(bill => bill.billStatus === 'Pending' || bill.billStatus === 'Overdue')
                .reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
            const avgConsumption = allBills.reduce((sum, bill) => sum + (bill.totalConsumptionKwh || 0), 0) / totalBills;

            document.getElementById('totalBillsCount').textContent = totalBills;
            document.getElementById('pendingAmount').textContent = '₹' + pendingAmount.toFixed(2);
            document.getElementById('avgConsumption').textContent = avgConsumption.toFixed(2) + ' kWh';
            document.getElementById('quickStats').style.display = 'grid';
        }

        function updateBillCount() {
            const count = filteredBills.length;
            const billCountElement = document.getElementById('billCount');
            billCountElement.textContent = `${count} bill${count !== 1 ? 's' : ''}`;
        }

        function renderBillsTable(bills) {
            const tbody = document.getElementById('billsTableBody');
            const billsTableCard = document.getElementById('billsTableCard');
            const emptyState = document.getElementById('emptyState');

            if (!tbody) {
                console.error('Bills table body not found!');
                return;
            }

            if (bills && bills.length > 0) {
                let tableHtml = '';
                bills.forEach(bill => {
                    const billingDate = new Date(bill.billingDate).toLocaleDateString('en-IN');
                    const period = bill.billingMonth + '/' + bill.billingYear;

                    let statusBadge;
                    switch(bill.billStatus) {
                        case 'Paid':
                            statusBadge = '<span class="badge bg-success status-badge">Paid</span>';
                            break;
                        case 'Overdue':
                            statusBadge = '<span class="badge bg-danger status-badge">Overdue</span>';
                            break;
                        case 'Cancelled':
                            statusBadge = '<span class="badge bg-secondary status-badge">Cancelled</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge bg-warning text-dark status-badge">Pending</span>';
                    }

                    // Determine if pay button should be enabled
                    const isPayable = (bill.billStatus === 'Pending' || bill.billStatus === 'Overdue');
                    const payButton = isPayable
                        ? `<button class="btn btn-sm pay-btn action-btn" onclick="payBill(${bill.billId})" title="Pay Bill">
                                <i class="bi bi-credit-card"></i>
                           </button>`
                        : `<button class="btn btn-sm pay-btn action-btn" disabled title="Already Paid">
                                <i class="bi bi-credit-card"></i>
                           </button>`;

                    tableHtml += `
                        <tr>
                            <td class="ps-4"><strong>${bill.billId}</strong></td>
                            <td>${bill.meterId}</td>
                            <td>${period}</td>
                            <td>${billingDate}</td>
                            <td>${(bill.totalConsumptionKwh || 0).toFixed(2)}</td>
                            <td class="amount-display">₹${(bill.totalAmount || 0).toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td class="text-center pe-4">
                                <div class="d-flex justify-content-center gap-1">
                                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="viewBillDetails(${bill.billId})" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success action-btn" onclick="downloadBillPDF(${bill.billId})" title="Download PDF">
                                        <i class="bi bi-file-pdf"></i>
                                    </button>
                                    ${payButton}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = tableHtml;

                // Show table, hide empty state
                billsTableCard.style.display = 'block';
                emptyState.style.display = 'none';
            } else {
                tbody.innerHTML = '';

                // Show empty state, hide table
                billsTableCard.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }

        function viewBillDetails(billId) {
            const bill = allBills.find(b => b.billId === billId);
            if (!bill) {
                showError('Bill not found');
                return;
            }

            currentBillForDetails = bill;

            const billingDate = new Date(bill.billingDate).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const period = `${getMonthName(bill.billingMonth)} ${bill.billingYear}`;

            let statusBadge;
            switch (bill.billStatus) {
                case 'Paid':
                    statusBadge = '<span class="badge bg-success fs-6 p-2"><i class="bi bi-check-circle me-1"></i>PAID</span>';
                    break;
                case 'Overdue':
                    statusBadge = '<span class="badge bg-danger fs-6 p-2"><i class="bi bi-exclamation-triangle me-1"></i>OVERDUE</span>';
                    break;
                case 'Cancelled':
                    statusBadge = '<span class="badge bg-secondary fs-6 p-2"><i class="bi bi-x-circle me-1"></i>CANCELLED</span>';
                    break;
                default:
                    statusBadge = '<span class="badge bg-warning text-dark fs-6 p-2"><i class="bi bi-clock me-1"></i>PENDING</span>';
            }

            // Update modal content
            document.getElementById('viewBillId').textContent = bill.billId;
            document.getElementById('viewBillIdInfo').textContent = bill.billId;
            document.getElementById('viewMeterId').textContent = bill.meterId;
            document.getElementById('viewBillingPeriod').textContent = period;
            document.getElementById('viewBillingPeriodInfo').textContent = period;
            document.getElementById('viewBillingDate').textContent = billingDate;
            document.getElementById('viewStatus').innerHTML = statusBadge;
            document.getElementById('viewStatusModal').textContent = bill.billStatus;
            document.getElementById('viewTotalConsumption').textContent = (bill.totalConsumptionKwh || 0).toFixed(2);
            document.getElementById('viewTotalAmount').textContent = '₹' + (bill.totalAmount || 0).toFixed(2);
            document.getElementById('viewTotalAmountModal').textContent = '₹' + (bill.totalAmount || 0).toFixed(2);

            // Update pay button state in modal
            const payBillBtn = document.getElementById('payBillBtn');
            const isPayable = (bill.billStatus === 'Pending' || bill.billStatus === 'Overdue');
            if (isPayable) {
                payBillBtn.disabled = false;
                payBillBtn.onclick = () => payCurrentBill();
            } else {
                payBillBtn.disabled = true;
                payBillBtn.onclick = null;
            }

            // Update consumption progress (example: assuming 1000 kWh is high consumption)
            const consumption = bill.totalConsumptionKwh || 0;
            const progressWidth = Math.min((consumption / 1000) * 100, 100);
            document.getElementById('consumptionProgress').style.width = progressWidth + '%';

            viewBillModal.show();
        }

        async function payBill(billId) {
            const bill = allBills.find(b => b.billId === billId);
            if (!bill) {
                showError('Bill not found');
                return;
            }

            currentBillForPayment = bill;
            await showPaymentConfirmation();
        }

        async function payCurrentBill() {
            if (currentBillForDetails) {
                currentBillForPayment = currentBillForDetails;
                await showPaymentConfirmation();
            }
        }

        async function showPaymentConfirmation() {
            if (!currentBillForPayment) return;

            // Reset validation result
            document.getElementById('paymentValidationResult').style.display = 'none';
            document.getElementById('paymentValidationResult').innerHTML = '';

            // Update confirmation modal content
            document.getElementById('confirmBillId').textContent = currentBillForPayment.billId;
            document.getElementById('confirmBillAmount').textContent = '₹' + (currentBillForPayment.totalAmount || 0).toFixed(2);
            document.getElementById('confirmBillPeriod').textContent = `${getMonthName(currentBillForPayment.billingMonth)} ${currentBillForPayment.billingYear}`;

            // Validate sequential payment first
            try {
                const validationResult = await validateSequentialPayment(currentBillForPayment.billId);

                if (!validationResult.isValid) {
                    // Show validation error
                    document.getElementById('paymentValidationResult').innerHTML = `
                        <div class="alert alert-danger validation-alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Payment Validation Failed:</strong>
                            <div class="mt-1">${validationResult.errorMessage}</div>
                            ${validationResult.unpaidBillId ?
                                `<button class="btn btn-sm btn-outline-danger mt-2" onclick="viewUnpaidBill(${validationResult.unpaidBillId})">
                                    <i class="bi bi-eye me-1"></i>View Unpaid Bill
                                </button>` : ''
                            }
                        </div>
                    `;
                    document.getElementById('paymentValidationResult').style.display = 'block';
                    document.getElementById('confirmPaymentBtn').disabled = true;
                } else {
                    document.getElementById('confirmPaymentBtn').disabled = false;
                }
            } catch (error) {
                console.error('Error validating payment:', error);
                document.getElementById('confirmPaymentBtn').disabled = false;
            }

            paymentConfirmationModal.show();
        }

        async function validateSequentialPayment(billId) {
            try {
                const response = await fetch(`${BILL_API_URL}/ValidateSequentialPayment/${billId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Validation failed: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error validating sequential payment:', error);
                return { isValid: false, errorMessage: 'Unable to validate payment sequence' };
            }
        }

        function viewUnpaidBill(billId) {
            paymentConfirmationModal.hide();
            viewBillDetails(billId);
        }

        async function processPayment() {
            if (!currentBillForPayment) return;

            // Show processing modal
            paymentConfirmationModal.hide();
            paymentProcessingModal.show();

            try {
                // Update bill status to "Paid"
                const updateRequest = {
                    billStatus: "Paid"
                };

                const response = await fetch(`${BILL_API_URL}/UpdateBillStatus/${currentBillForPayment.billId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateRequest)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Payment failed: ${response.status}`);
                }

                const result = await response.json();

                // Simulate payment processing delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Show success modal
                paymentProcessingModal.hide();
                showPaymentSuccess(result);

            } catch (error) {
                console.error('Payment processing error:', error);
                paymentProcessingModal.hide();
                showError('Payment failed: ' + error.message);
            }
        }

        function showPaymentSuccess(result) {
            document.getElementById('successBillId').textContent = currentBillForPayment.billId;
            document.getElementById('successBillAmount').textContent = '₹' + (currentBillForPayment.totalAmount || 0).toFixed(2);
            document.getElementById('successTransactionDate').textContent = new Date().toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            paymentSuccessModal.show();
        }

        function handlePaymentSuccess() {
            // Generate receipt first
            generatePaymentReceipt();

            // Close the success modal
            paymentSuccessModal.hide();

            // Wait for modal to close, then reload
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        function generatePaymentReceipt() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const bill = currentBillForPayment;
                const consumption = parseFloat(bill.totalConsumptionKwh) || 0;
                const amount = parseFloat(bill.totalAmount) || 0;

                const billingDate = new Date(bill.billingDate).toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const period = `${getMonthName(bill.billingMonth)} ${bill.billingYear}`;
                const paymentDate = new Date().toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Header
                doc.setFillColor(40, 167, 69);
                doc.rect(0, 0, 210, 40, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('PAYMENT RECEIPT', 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Meter Data Management System', 105, 30, { align: 'center' });

                // Reset text color
                doc.setTextColor(0, 0, 0);

                // Consumer Information
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Consumer Information', 20, 55);

                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                let yPos = 65;

                if (currentConsumerData) {
                    doc.text('Name: ' + String(currentConsumerData.name || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Consumer ID: ' + String(currentConsumerData.consumerId || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Address: ' + String(currentConsumerData.address || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Phone: ' + String(currentConsumerData.phone || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Email: ' + String(currentConsumerData.email || 'N/A'), 20, yPos);
                } else {
                    doc.text('Consumer ID: ' + String(bill.consumerId), 20, yPos);
                }

                // Payment Details
                yPos += 15;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Payment Details', 20, yPos);

                yPos += 10;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('Bill ID: ' + String(bill.billId), 20, yPos);
                yPos += 7;
                doc.text('Meter ID: ' + String(bill.meterId), 20, yPos);
                yPos += 7;
                doc.text('Billing Period: ' + period, 20, yPos);
                yPos += 7;
                doc.text('Billing Date: ' + billingDate, 20, yPos);
                yPos += 7;
                doc.text('Payment Date: ' + paymentDate, 20, yPos);

                // Payment Amount Box
                yPos += 15;
                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos, 170, 25, 'F');
                doc.setDrawColor(40, 167, 69);
                doc.setLineWidth(0.5);
                doc.rect(20, yPos, 170, 25);

                yPos += 10;
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(40, 167, 69);
                doc.text('Amount Paid:', 30, yPos);
                doc.text('Rs. ' + amount.toFixed(2), 160, yPos, { align: 'right' });

                // Status
                yPos += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.text('Status: PAID', 20, yPos);

                // Footer
                doc.setTextColor(128, 128, 128);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('This is an electronic payment receipt. For queries, please contact customer service.', 105, 280, { align: 'center' });
                doc.text('Generated on: ' + new Date().toLocaleString('en-IN'), 105, 286, { align: 'center' });

                // Save PDF
                const fileName = `Payment_Receipt_${bill.billId}_${new Date().getTime()}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating receipt:', error);
                // Don't show error for receipt generation failure
            }
        }

        function downloadCurrentBillPDF() {
            if (currentBillForDetails) {
                downloadBillPDF(currentBillForDetails.billId);
            }
        }

        function downloadBillPDF(billId) {
            const bill = allBills.find(b => b.billId === billId);
            if (!bill) {
                showError('Bill not found');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const consumption = parseFloat(bill.totalConsumptionKwh) || 0;
                const amount = parseFloat(bill.totalAmount) || 0;

                const billingDate = new Date(bill.billingDate).toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const period = `${getMonthName(bill.billingMonth)} ${bill.billingYear}`;

                // Header
                doc.setFillColor(0, 123, 255);
                doc.rect(0, 0, 210, 40, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('ELECTRICITY BILL', 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Meter Data Management System', 105, 30, { align: 'center' });

                // Reset text color
                doc.setTextColor(0, 0, 0);

                // Consumer Information
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Consumer Information', 20, 55);

                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                let yPos = 65;

                if (currentConsumerData) {
                    doc.text('Name: ' + String(currentConsumerData.name || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Consumer ID: ' + String(currentConsumerData.consumerId || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Address: ' + String(currentConsumerData.address || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Phone: ' + String(currentConsumerData.phone || 'N/A'), 20, yPos);
                    yPos += 7;
                    doc.text('Email: ' + String(currentConsumerData.email || 'N/A'), 20, yPos);
                } else {
                    doc.text('Consumer ID: ' + String(bill.consumerId), 20, yPos);
                }

                // Bill Information
                yPos += 15;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Bill Details', 20, yPos);

                yPos += 10;
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text('Bill ID: ' + String(bill.billId), 20, yPos);
                yPos += 7;
                doc.text('Meter ID: ' + String(bill.meterId), 20, yPos);
                yPos += 7;
                doc.text('Billing Period: ' + period, 20, yPos);
                yPos += 7;
                doc.text('Billing Date: ' + billingDate, 20, yPos);
                yPos += 7;
                doc.text('Status: ' + String(bill.billStatus), 20, yPos);

                // Consumption and Amount Box
                yPos += 15;
                doc.setFillColor(240, 240, 240);
                doc.rect(20, yPos, 170, 35, 'F');
                doc.setDrawColor(0, 123, 255);
                doc.setLineWidth(0.5);
                doc.rect(20, yPos, 170, 35);

                yPos += 10;
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Total Consumption:', 30, yPos);
                doc.text(consumption.toFixed(2) + ' kWh', 160, yPos, { align: 'right' });

                yPos += 12;
                doc.setFontSize(16);
                doc.setTextColor(40, 167, 69);
                doc.text('Total Amount:', 30, yPos);
                doc.text('Rs. ' + amount.toFixed(2), 160, yPos, { align: 'right' });

                // Footer
                doc.setTextColor(128, 128, 128);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text('This is a computer-generated bill. For queries, please contact customer service.', 105, 280, { align: 'center' });
                doc.text('Generated on: ' + new Date().toLocaleString('en-IN'), 105, 286, { align: 'center' });

                // Save PDF
                const fileName = 'Bill_' + bill.billId + '_' + period.replace(' ', '_') + '.pdf';
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                showError('Failed to generate PDF: ' + error.message);
            }
        }

        function getMonthName(monthNumber) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[monthNumber - 1];
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            if (message) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
            } else {
                errorDiv.style.display = 'none';
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            if (message) {
                successText.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => { successDiv.style.display = 'none'; }, 5000);
            } else {
                successDiv.style.display = 'none';
            }
        }
    </script>
}